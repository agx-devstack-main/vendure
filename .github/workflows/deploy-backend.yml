name: Deploy Vendure Backend to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug - Check SSH key
        run: |
          echo "SSH_PRIVATE_KEY length: ${#SSH_PRIVATE_KEY}"
          echo "First 50 chars: ${SSH_PRIVATE_KEY:0:50}"
          echo "Last 50 chars: ${SSH_PRIVATE_KEY: -50}"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Deploy to Azure VM
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/deploy_key << 'KEYFILE'
          ${{ secrets.SSH_PRIVATE_KEY }}
          KEYFILE
          chmod 600 ~/.ssh/deploy_key
          
          ssh-keyscan -H ${{ secrets.VM_IP }} >> ~/.ssh/known_hosts 2>/dev/null
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} << 'DEPLOY_SCRIPT'
          cd ${{ secrets.VM_APP_PATH }}
          git pull origin main
          npm install
          npm run build
          pm2 restart vendure-backend
          pm2 save
          DEPLOY_SCRIPT

